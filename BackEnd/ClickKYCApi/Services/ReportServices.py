import io
import base64
from datetime import datetime
import os
from jinja2 import Environment, FileSystemLoader, select_autoescape
from weasyprint import HTML
from pathlib import Path
from Cache.AppSettingsCache import Get
from Schemas.shared import SystemLogErrorSchema, CustomerRegistrationSchema
from Services.CommonServices import DecryptImage, GetSha1Hash
from Services.LogServices import AddLogOrError
import traceback

report_template_path = Path(__file__).resolve().parent.parent / "Templates"



DEFAULT_USER_PHOTO = "iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAGHaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49J++7vycgaWQ9J1c1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCc/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+PHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj48cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0idXVpZDpmYWY1YmRkNS1iYTNkLTExZGEtYWQzMS1kMzNkNzUxODJmMWIiIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj48dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPjwvcmRmOkRlc2NyaXB0aW9uPjwvcmRmOlJERj48L3g6eG1wbWV0YT4NCjw/eHBhY2tldCBlbmQ9J3cnPz4slJgLAAAXOUlEQVR4Xu3d+1NU5+EG8Ofc9sp1uSoIoohZYcJgGmNqTMaMTNJO+s92OtNMbKajNW1sU9F6QSKhAUQBAWEXds+ey3u+P3z3PV03gmDY6/t8ZnYcOSsJy3mf93reV3McJwARKUcIEejlXyQidTAAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhDAAihTEAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhDAAihTEAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhDAAihTEAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhDAAihTEAiBTGACBSmOY4TlD+RWoemqZB13Xo+tGyXggBIQSCgLdHsxJCBAyAJmQYxmsF3nVd2LaNQqEQvjzPgxAifL9lWYhEIohGo4jFYojFYjAMI/weQgj4vh/+nRofA6BJaJoGwzCgaRoAwLZtbG5uhq9Xr14hm82Ghd/3/bCGBxC2EEzTRCQSQTweR2trK7q6upBKpdDV1YWuri5YlgWwddA0GAANTtf1sJbO5XJYWVnB0tISVldXsbW1hXw+D9/3w2DQNC3sEsivSUEQhIW6tGAbhoFEIoFUKoWBgQEMDw+jv78f0WgUAMIwocbDAGhQsuAHQYD19XU8ffoUP/30E16+fAnXdcPr5YVd07S31tql75GhUFrjRyIR9Pf3Y3R0FKOjo0ilUgAAz/Pe+r2pvjAAGpBshq+srODhw4f48ccfkc1mw368rOUrQQaC67oIggCdnZ04f/480uk0+vv7geJ4AzUGBkADkQV/fX0d9+7dw+zsLHZ3d8PBu8PU7sdNDiZ2dHRgYmICk5OT6Ojo4IBhg2AANABN02CaJmzbxr1793D37l1sb2/Dsqywxq92wZc0TQtbBL7vo7u7G5cuXcLExAQMw2C3oM4xAOqcnM579uwZbt26haWlJei6XrMafz8yCAqFAjRNw3vvvYcrV66gu7ubg4R1jAFQx0zTRBAEmJmZwXfffYe9vT3EYrGK9e+PixACtm0jlUrh2rVrOH/+PLsEdYoBUKcsy4Jt27h16xbu3r0LXdcRjUbrpsY/iAyofD4P0zRx5coVfPTRR9A0DZ7nlb+daogBUIcsy8LOzg5u3LiBubk5RKNRWJbVEIW/lKZpcBwHnufh4sWL+OyzzxCLxThLUEcYAHXGsixsb2/jz3/+MxYWFpBIJOq+yX8QWesXCgVMTEzg+vXrSCQSDIE6IYQIjvaECFWMrPn/9Kc/4b///W/DF34U1w2Ypol4PI4HDx7gm2++gW3bME2z/K1UIwyAOmCaJrLZLL7++mssLS0hHo83fOGXgiCArutIJBJ4/Pgxvv32W7iuyxCoEwyAGjNNE57n4a9//Svm5+ebqvBLMgRisRju3buHv//979CKDzBRbTEAakiu0//+++/x8OHDhpjme1dBEMAwDESjUdy5cwf3799/40NJVF0MgBqRNeCTJ0/w/fffw7Kspm8WB0EQLmm+efMmnj171vQ/c71jANSAHBzb2trCrVu3IIRAJBJpuKm+dxEEAWKxGHZ3d3Hz5s1wvQDVBgOgBuSjvP/4xz/w8uXLhlnkc1yCIEA8Hsfi4iJ++OEHaBV8gpEOxgCoAdn0f/z4cbixhmq04kNOMzMzWFlZYSugRhgAVWaaJnK5HP71r3/B8zylb/xIJILd3V3885//hOu6nBWoAQZAFcmm7qNHj7CysqJs7S9pmoZoNIr5+XksLCwceedi+vX4iVeRXPDz4MEDzoOXDIY6joP79++jUCgo3SKqBQZAlchBrqdPn2JtbU25gb/9yFmBpaUlLC8vczCwyhgAVaLrOmzbxuzsLEe9yxiGAcdx8PjxYwgh2BWoIn7SVSJ39lldXUUkEim/rDzLsrC4uIiNjQ3lu0bVxACoAlnbz8/Pw3Ec1nBvYJom9vb28NNPP5VfogrinVgFhmEgk8lgeXmZhX8fslu0uLjIKcEq4t1YBZqm4cWLF9jZ2eEo9wF0Xcf6+jpevnzJoKwSfsoVJpv/L168gOd5vLEPoOs68vk8VldXyy9RhfBurDA5wr22tgaUBAL9kmEYEEJgbW0t3EOAKoufcIVpmoadnR28evWK03+HoGkaNjY2kM/nGQBVwE+4CjKZDHK5XPgUIL2ZVjzMNJvNIpvNMiyrgAFQQfIGzmQy4am9tD/Z7LdtG9lstvwyVQDvyAoqDQCucDsceabg3t4ewDGTiuMdWUGapsH3fezu7oZ/p7fzfZ8tgCphAFSY7/soFArs+x+SVjz01LZtBEHA0KwwBkAFaSXHZ/NGPhw5U+K6LoQQ/NwqjAFQYUIIeJ7HG/mIPM9jq6kKGABUd4IggBCCAVAFDACqSzoPDakKBkAFyXltucSVDkcrbpcmBwSpchgAFWYYBjcAOQJZ4E3T5LqJKuAnXGF68VBMOppmPCS1HjEAKigoHoiZTCbZnD0kuWKytbUVKGkRUGUwACpI9vvb2to4DnBIQgiYpomWlhaAAVBxDIAqaGtrg2maDIC3kEun4/F42AKgymIAVEFbWxsSiQR832e/9gBBECAIArS2tjIAqoQBUGFBEKCtrQ0dHR1c3HJIXV1diMfj8H2//BIdMwZAhfm+j2g0ir6+PoB92gPJAcD+/v7wOQqqLAZAhckCf+LECViWxVrtAL7vIxaLob+/v/wSVQgDoEpOnDiB9vZ21moH8H0fPT096O7uZlBWCQOgCjzPQ1tbGwYHB3lj70O2lE6fPo1IJMKgrBIGQBUExY0tzp07x27APnzfR0tLC86cOVN+iSqIAVAlQggMDg6iv78fruuWX1ae4zgYGhpCT08Pa/8qYgBUiRACsVgM6XQ6nO+m/yeEgGVZuHDhAnRdZwupihgAVSIL/OjoKHp6elAoFLgoqLj6z7ZtnD59GkNDQ6z9q4wBUEWe56G9vR3vv/8+giBQvqaTe/9ZloXJyUkO/tUAA6CKZNN/fHwcAwMDsG27/C1KCYIAjuNgdHQUZ8+e5UrJGmAAVJnneUgmk/jwww9hmiY8zyt/izJc1w0/C8MwlG8R1QIDoAaEEBgbG0M6nYbjOOWXlRAEATzPw9TUFAYHB5UOwlpiANSA7/swDAO//e1v0d3drdyAoKZpyOfzGBoawm9+8xvOitQQA6BGXNdFV1cXrl69Cl3XlVkboGkaCoUCkskkPv30UyQSCdb+NcQAqCHf95FOp3Hp0iUUCgUlRsDliT+ffvopTp06xcJfYwyAGpKj3pcvX8bExATy+XxTN4WFEHAcB5cuXcLk5CR832/qn7cRMABqzPM8RKNRXL9+HWfOnEEul2vKQiGEQD6fx/vvv48rV67wef86wQCoA3I67Msvv8Tg4CByuRzQJMeJy4Kez+eRTqdx/fp1RKNRNv3rBAOgTriui87OTnz11VcYHh7G7u5uw8+Ly00+8/k8xsfH8eWXXyIWiykz4NkINMdxmq+92cAsy0Imk8GNGzcwOzuLeDwO0zQbrlsgl/k6joOpqSlcu3aNhb/OCCECBkAdsiwL+XweN2/exP3796HrOizLKn9bXSsUCjAMA5cvX8ZHH32k/KrHesQAqGOWZcHzPNy/fx+3b9/G3t4eYrEYDMOo69aAEAK2bSOVSuGzzz5DOp2GEKLhuzPNiAFQ5wzDgK7rWF5ext/+9jcsLi5C13VEo9G6OmpMDvTJFY1jY2O4evVquLcfR/vrEwOgAWiaBtM0Yds2ZmZm8O9//xs7OzuIRqOwLKsuQsBxHLiui97eXnz44YcYHx8PWzD18P9Hb8YAaCCyNbC2toaZmRnMzc1hb28PkUgEhmFUfcpQPszjui7a2towPj6OyclJpFIpNvkbBAOggQRBAF3XwzMGV1ZW8ODBA8zPz2N3dxeGYcA0Tei6fuxhILsbQXETE9msb29vx/nz5zExMREefMJR/sbBAGhQuq6Hpw2vr6/jxx9/xMLCAjY3N+E4DjRNC8OiNBAO0xwvDY8gCCCEgOd5kMuWY7EYenp6MDo6inPnziGVSoXz/ezrNxYGQIOTQQAAuVwOz549w/LyMp4/f47t7W3kcrmwKS7fq2la+Cola3jZfA+KW5kbhoFEIoGuri4MDAxgcHAQAwMDiEajQHEp82GCheoPA6BJyIIqC/Xe3h62t7exsbGBjY0N7OzsIJPJwLZtOI4T1uil/17TNFiWBcuykEgk0NLSglQqhZ6eHqRSKXR2diIWiwEl/X9qbAyAJlQeBiiO0hcKhfBP13Xhum5Yc8uFRpZlIRqNIhKJhC9J9v9Z2zcPBkCTK23uv6nZvx/ZHZBdAmpODAAihQkhAj4NSKQwBgCRwhgARApjABApjAFApDDOAhyTw06x0fHgeoRfj9OAv0LpMlyqLT6H8G4YAO/ANM2wtt/e3sbOzg52d3eRz+e5PLZKLMtCPB5HW1sb2tvb0draCjAIjowBcASyxi8UClhYWMDCwgJWV1eRzWbhOA5vvCrSik87RiIRtLe34+TJkxgdHcXw8HB4yjB/H2/HADgky7IghMCTJ08wMzOD58+fw/O8cN19+dp7qjwhBEqfXIxGoxgaGsIHH3yA06dPQyvuSkz7YwC8hVbcjmtnZwe3b9/Go0ePIISAaZphV4CDUbWlFfcj9H0fjuMgFothamoKH3/8MbchfwsGwAFk4X/x4gW+/vprPH/+HPF4vO535VWd53koFAoYGxvD9PQ0Ojo6GAL7YAAcwLIsPH/+HH/84x+xtbWFZDIJcPqp7skWwd7eHoaHh/GHP/yBIbAPPgy0D8uysL29jW+++Qabm5tIJBLh47FU34Li3onJZBKLi4v4y1/+Atu2YZpm+VuJKwF/Se61d/v2baysrCCRSJS/hepcUNzOLJFIYG5uDnfu3AGKMzn0On4iJeT00uzsLB49eoRoNMqbpoEZhgHLsnD37l0sLS1x4dYb8O4uYRgGcrkc7t69CyFE3Ry8Qe9GTg/K36nrugyBMgyAIrll1s8//4yVlRVEo1EW/iYgQ+Dnn3/G6uoqW3Rl+GkUacW97efn5yGE4I3SREzTRC6Xw8LCQvkl5fEuL9J1HdlsFi9evGi4o7jp7QzDwPLyMmzbZjegBAOgSNM0bGxshMdsUXMxTRPb29vIZrNs3ZXgJ1Eik8mEa/ypuei6DsdxkMlkyi8pjQFQIpfLceCvifm+j3w+X/5lpTEASvB5/uYWFE83ov9hAJAS2K17MwYAkcIYAEQKYwCU4PRf82NX4HUMgBKlG35Sc5FPCPKx4NcxAEpYlsUAaGKGYTAAyjAASsRiMYC7/jSlIAhgGAbi8Xj5JaUxAEokk0mYpskAaEJBECASiXCDlzIMgBJtbW2Ix+PcU74JCSEQi8UQj8cZ8CUYAEVCCCQSCSSTSQZAE/J9Hx0dHYhEIvz9lmAAFMmNI1KpFJeLNqEgCNDd3c1t3cswAIqC4m6yvb29nAloMrL/z9/tLzEAimSt0N/fj3g8zlZAk9CKR4S1tLSgt7cXAbd3fw0DoEQQBOjq6kIqlYLjOKwtmoTneejr60NLSwsLfxkGQAkhBJLJJIaGhlhTNAkhBAzDwMjISHjIK/0PA6CEvDlGRkaQSCTgui5bAQ3OdV20t7fj1KlTABd5/QIDoIwQAidPnsTAwAA3CGlwQXEDkJGREc7u7IMBUMb3fViWhffeew+GYTAEGpjneYjH40in09CKh4bS6xgAbyCEwOjoKE6cOMFTZRuY53k4e/YsTp06xdp/HwyAN/B9H/F4HBcvXoSu66w5GpCs/aemplj7H4ABsA8hBMbGxnDmzBnYtl1+mepcoVDAxMQEBgYGWPsfgAGwDzkWcPnyZc4INBBN05DP59Hb24sPPviAtf9bMAAO4Ps+BgcHcenSJbiuC9/3GQJ1Tp4A/PHHH6Ozs5ODuG/BADiAEAJBEODixYsYGxtDPp/nPHIdC4IAhUIBk5OTSKfT4e+P9scAeAvP8xCLxXDt2jX09PQgl8uVv4XqRD6fx8jICK5evQpd19n3PwQGwCG4rouuri5MT08jmUyiUCiUv4VqSPb7e3p6MD09jUQiwab/ITEADsnzPIyMjGB6ehqmacJxHJ4yWwdk4W9pacEXX3yBnp4ert04At7BhySXlV64cAGff/55eONxULB2NE1DLpdDIpHA73//ewwNDbHmPyIGwBEIISCEwNTUFKanp2FZFkOghnK5HNra2vDVV1/h7Nmz8DyPg35HpDmOw0/siHRdh2EYmJubw40bN5DNZhGPx6FpGm/ACpPz+rlcDn19ffjd734XPrjFz/5ohBABA+AdacVTZpaXl/Htt99iZWUFsViM24pXkFbc3adQKODcuXP4/PPP0d3dzcL/jhgAv5IMgZ2dHdy8eROPHj2CYRiIRqO8IY+RbFnZtg1d13Hx4kV88skniMViHPD7FRgAx8SyLLiui5mZGdy5cwfZbBaxWIw70B4T3/dRKBTQ3d2NTz75BOl0GijOzNC7YwAcI8MwoOs6VldX8d1332F+fh4AEIlEoOs6g+CINE2D7/twHAeGYWB8fDxc3iuE4CKfY8AAOGayS+A4DmZnZ/HDDz9gfX0duq4zCA5JDvLJxVbyWYzR0VHous7+/jFiAFSIbA1kMhk8fPgQ//nPf7C1tRWOD3C24JdKC34QBOjr68Pk5CQuXLgQbtPOp/qOFwOgwizLAgBsbGxgdnYWs7Oz2NzchK7rsCyLKwmLC6yEEOHj1r29vZiYmMDY2Bja29sRBAH7+hXCAKgC2S0AgJ2dHczNzeHJkydYX18PH101TRO6rivRMpA/o+/78DwPQghEo1GcOHEC6XQaZ8+eRWtrK1B8BoMqhwFQRXLxEIpPrS0tLeHp06dYXl5GJpOBECJsGcj3NUsYvKnQm6aJjo4ODA0NYWxsDAMDA4hEIkBxdL9ZfvZ6xgCoAU3TYBgGtOLy4Y2NDSwvL2NxcRGrq6vY2dmB7/uvdRPkexuNLPSyJpeF/uTJkxgeHsapU6fQ3t4OlCyzZsGvHgZAjZW2Cnzfx+bmJtbW1vDs2TOsra1he3sbtm0jKB5cKgcXZSDUSzDIQiv783LATtM0xONxdHV1ob+/HydPnkR/fz9SqVT4b1nb1w4DoI7Iwo1ibZjL5bC9vY3V1VWsr69jc3MTmUwGtm2HhUbTtH1feIeAkE31cqUFfL+XVhzrSCQSaG9vR1dXF/r6+tDX14f29nYkEonw+3FEvz4wAOqQLMClNb1sRmezWbx69QpbW1t49eoVstksdnd3kc/n4bouPM+D7/uvFdjyECj/e6n9Cr/8N7quh10Ty7IQj8fR2tqKtrY2dHZ2orOzE6lUCslk8rVZDtkyYKGvLwyABlBaq5dPG3qeB9u2sbe3h3w+H/6Zz+dh2zYKhQJs2/5FOMgCKQu8DBv539CLC5dM00Q0GkUsFgtfyWQSiUQC8Xg8/FN2Y6TSwv6mUKH6wABoYKWFdT9BcQ5dFn5Z6PcLgNI/DcMIpyj3azWUfh8W9MbDAGhSssCWth72K8T7kYW69EXNhQFApDAhRLB/+5GImh4DgEhhDAAihTEAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhDAAihTEAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhDAAihTEAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhDAAihTEAiBTGACBSGAOASGEMACKFMQCIFMYAIFIYA4BIYQwAIoUxAIgUxgAgUhgDgEhhmm3bovyLRKSE4P8AzVEZyj6sXiYAAAAASUVORK5CYII="
DEFAULT_ID_PHOTO = "/9j/4AAQSkZJRgABAQEBLAEsAAD/4QEMRXhpZgAATU0AKgAAAAgABQEOAAIAAACcAAAASgESAAMAAAABAAEAAAEaAAUAAAABAAAA5gEbAAUAAAABAAAA7oKYAAIAAAAOAAAA9gAAAABJRCBDYXJkIGlzb2xhdGVkIG9uIHdoaXRlIGJhY2tncm91bmQuIElkZW50aWZpY2F0aW9uIGNhcmQgaWNvbi4gQnVzaW5lc3MgaWRlbnRpdHkgSUQgY2FyZCBpY29uIHRlbXBsYXRlIGJhZGdlLiBJZGVudGlmaWNhdGlvbiBwZXJzb25hbCBjb250YWN0IGluIGZsYXQgc3R5bGUAAAEsAAAAAQAAASwAAAABUGhvdG9wbG90bmlrb3b/4QZBaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/Pg0KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyI+DQoJPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4NCgkJPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczpJcHRjNHhtcENvcmU9Imh0dHA6Ly9pcHRjLm9yZy9zdGQvSXB0YzR4bXBDb3JlLzEuMC94bWxucy8iIHhtbG5zOkdldHR5SW1hZ2VzR0lGVD0iaHR0cDovL3htcC5nZXR0eWltYWdlcy5jb20vZ2lmdC8xLjAvIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBsdXM9Imh0dHA6Ly9ucy51c2VwbHVzLm9yZy9sZGYveG1wLzEuMC8iIHhtbG5zOmlwdGNFeHQ9Imh0dHA6Ly9pcHRjLm9yZy9zdGQvSXB0YzR4bXBFeHQvMjAwOC0wMi0yOS8iIHhtbG5zOnhtcFJpZ2h0cz0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3JpZ2h0cy8iIGRjOlJpZ2h0cz0iUGhvdG9wbG90bmlrb3YiIHBob3Rvc2hvcDpDcmVkaXQ9IkdldHR5IEltYWdlcy9pU3RvY2twaG90byIgR2V0dHlJbWFnZXNHSUZUOkFzc2V0SUQ9IjYxMjY1MDkzNCIgeG1wUmlnaHRzOldlYlN0YXRlbWVudD0iaHR0cHM6Ly93d3cuaXN0b2NrcGhvdG8uY29tL2xlZ2FsL2xpY2Vuc2UtYWdyZWVtZW50P3V0bV9tZWRpdW09b3JnYW5pYyZhbXA7dXRtX3NvdXJjZT1nb29nbGUmYW1wO3V0bV9jYW1wYWlnbj1pcHRjdXJsIiBwbHVzOkRhdGFNaW5pbmc9Imh0dHA6Ly9ucy51c2VwbHVzLm9yZy9sZGYvdm9jYWIvRE1JLVBST0hJQklURUQtRVhDRVBUU0VBUkNIRU5HSU5FSU5ERVhJTkciPg0KCQkJPGRjOmNyZWF0b3I+PHJkZjpTZXE+PHJkZjpsaT5QaG90b3Bsb3RuaWtvdjwvcmRmOmxpPjwvcmRmOlNlcT48L2RjOmNyZWF0b3I+PGRjOmRlc2NyaXB0aW9uPjxyZGY6QWx0PjxyZGY6bGkgeG1sOmxhbmc9IngtZGVmYXVsdCI+SUQgQ2FyZCBpc29sYXRlZCBvbiB3aGl0ZSBiYWNrZ3JvdW5kLiBJZGVudGlmaWNhdGlvbiBjYXJkIGljb24uIEJ1c2luZXNzIGlkZW50aXR5IElEIGNhcmQgaWNvbiB0ZW1wbGF0ZSBiYWRnZS4gSWRlbnRpZmljYXRpb24gcGVyc29uYWwgY29udGFjdCBpbiBmbGF0IHN0eWxlPC9yZGY6bGk+PC9yZGY6QWx0PjwvZGM6ZGVzY3JpcHRpb24+DQoJCQk8cGx1czpMaWNlbnNvcj48cmRmOlNlcT48cmRmOmxpIHJkZjpwYXJzZVR5cGU9IlJlc291cmNlIj48cGx1czpMaWNlbnNvclVSTD5odHRwczovL3d3dy5pc3RvY2twaG90by5jb20vcGhvdG8vbGljZW5zZS1nbTYxMjY1MDkzNC0/dXRtX21lZGl1bT1vcmdhbmljJmFtcDt1dG1fc291cmNlPWdvb2dsZSZhbXA7dXRtX2NhbXBhaWduPWlwdGN1cmw8L3BsdXM6TGljZW5zb3JVUkw+PC9yZGY6bGk+PC9yZGY6U2VxPjwvcGx1czpMaWNlbnNvcj4NCgkJPC9yZGY6RGVzY3JpcHRpb24+DQoJPC9yZGY6UkRGPg0KPC94OnhtcG1ldGE+DQo8P3hwYWNrZXQgZW5kPSd3Jz8+/+0BAFBob3Rvc2hvcCAzLjAAOEJJTQQEAAAAAADkHAJQAA5QaG90b3Bsb3RuaWtvdhwCeACcSUQgQ2FyZCBpc29sYXRlZCBvbiB3aGl0ZSBiYWNrZ3JvdW5kLiBJZGVudGlmaWNhdGlvbiBjYXJkIGljb24uIEJ1c2luZXNzIGlkZW50aXR5IElEIGNhcmQgaWNvbiB0ZW1wbGF0ZSBiYWRnZS4gSWRlbnRpZmljYXRpb24gcGVyc29uYWwgY29udGFjdCBpbiBmbGF0IHN0eWxlHAJ0AA5QaG90b3Bsb3RuaWtvdhwCbgAYR2V0dHkgSW1hZ2VzL2lTdG9ja3Bob3Rv/9sAQwACAQECAQECAgICAgICAgMFAwMDAwMGBAQDBQcGBwcHBgcHCAkLCQgICggHBwoNCgoLDAwMDAcJDg8NDA4LDAwM/9sAQwECAgIDAwMGAwMGDAgHCAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwM/8AAEQgAdwC9AwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/aAAwDAQACEQMRAD8A/QD9sD9sXxD438f6n4e8PandaR4c0iZ7RmtXMU1/Khw7M45CZBAUEZxk14MfEGouc/2jqJPcm7kyf/Hqi1FzJql2zElmnkJJ7kuTUNffYbDQpU1GK/4J+DY7MK2KrSq1ZPV/cuyLf9vaj/0EdQ/8CpP/AIqj+3tR/wCgjqH/AIFSf/FVUoro5EcXO+5b/t7Uf+gjqH/gVJ/8VR/b2o/9BHUP/AqT/wCKqpRRyIOd9y3/AG9qA/5iOof+BUn/AMVQ3iG/QZOo34H/AF9Sf/FVUrt/gLYW+o+JPECXEEFwkfhnUpVWWMOEdYsq4z0YHkHqKmdoRcjSjFzmoX3OQPia9V8HU70EdQbt/wD4qnjX9QIz/aOoc9P9Kk/+Kr0LX/G194B+GPw+TSoNGj/tDRpLm5afSre4eeQXLqGZnUk8ADrWP8YNMspdP8Ja9ZWVtpj+KNLa6urS3XbBHOkrRs8a/wAKvgHb0BzisYVbtJrR3t8jerh+RO0rtWb+fY5R/EV9GuTqV+Oe90//AMVSJ4i1CRcjUb8g9D9qk5/8erubnUj8J/hj4TutHtrJdX8UQ3F/d6jcWqXMkUaSmJII/MBVAMbmIGST1xWVcSz/ABs8UeHtPtNHs7DXdRkFjcXVrH5MOoOz4EpjUBEZF+8V64zgURqp3dtFcmVBr3eb3tNPXY5tfEOoOCRqN+cccXT8f+PUh8TXoznVL4Edvtb/APxVeufHnwGb/wABXuqWHh250K38GX40tHkszbnUbBlCxXLHHzOJVbcx5xKtbOpaBr14ng/TvC+peAtOe/8AD9nIllqFva/ariYqSz4eNmfdgd8nBwKy+tRsml950/UJ8zi5bJfPppdrqeFnxJfgAnUr8A9zdSY/9CpV8R3zD5dSv2+l3J/8VXrtnqWjw+PviDqOgWmnE6V4X8zL6ePs6X6PGs0kUEq/IpfdgEDvwKwdB1o/F/wb4st9ZstJF9oWlNq9hqFrYx2ksTJIoaJ/LAV0cMcAjII4NUq91fl00/EiWEs+Xn97W3y/4Y4H+3tR/wCgjqH/AIFSf/FUf29qP/QR1D/wKk/+KqpnNFdfIjg533Lf9vaj/wBBHUP/AAKk/wDiqP7e1H/oI3//AIFSf/FVUoo5EHO+5b/t7Uf+gjqH/gVJ/wDFUHXtRH/MR1D/AMCpP/iqqUUciDnfc3vC3xS8TeCdVjvtJ8Q6zYXMZBDJdOyt7MpJVh7EGvvD9kj9rC2+PHgm4GsG20/X9GZIr1QdsVxvB2Sp6BtrZHYqe2K/PGmnxRqHhmbNhdzWhnQCQxnG8KWxn6bm/OvPx+X068drPue7kWdV8FWtF3i+nQnv/wDkJXP/AF2f/wBCNR4Poa9ab9mP+09XeKDVriSaeZwkaWwJY7jwPmq//wAMVaxnG/VeP+nNf/iq3ljKNOynJL1dvzPOhl2JqXdODa8k3+R4tg+howfQ17T/AMMVax/f1X/wDX/4qj/hirWP7+q/+Aa//FVH9pYb+dfei/7Ixn/PqX3P/I8WwfQ0YPoa9p/4Yq1j+/qv/gGv/wAVR/wxVrH9/Vf/AADX/wCKo/tLDfzr70H9kYz/AJ9S+5/5Hi2D6GtfwT40uPAl/f3FvBDO9/p1xpjiXICJOu1mGP4gOgr1L/hirWB/Hqv/AIBr/wDFVT1b9kq50Hy/tt/fWnmk7PNtFG/HXHzduPzqljcPU9xSTb80Dy3GUv3jg4pdbNfmclD8U7C48LaHpmqeEtH1o6BatZ21xNdXETmMyGTDKjAH5iaxvGvje98favHdXiW8CW0CWlra20fl29nAmdsca5OAMk5JJJJJNd1/wzZCP+Y1cc/9Ow/+Ko/4Zth7a1P/AOAw/wDiqcVTi7oioq81yyfbt0OU0H4kiy8MRaHq+i2PiDSrWZ7i0jnlkgmsXf8A1nlyIQQrYBKnIzzxWh/wva/tdQhex0zTNNtdO02407S7W33+XpnnjEs6kks87An52Petv/hmyH/oNT/+Aw/+KoP7NkOf+Q1P/wCAw/8AiqXLS10LjLExXLF2t6X+/wDI4nwT4+u/BNzfFYxqNrqNhNp11aXUrtFNFIuPXIZSAwI6EVH4u8b3XjC60maZI7aXRtPt9OheFiHxBnZJk9Hyc8dCK7r/AIZshH/Man/8Bh/8VR/wzbD/ANBqf/wHH/xVUnTvzWM+TEcvJfQyW+PM174n1PVr7QdKvrjXdKGl6qhkliTUMFSZ22kFZW2DO3APXGazdY+KKy+GLzSNG0HSfDdlqmz7cbV5Zp7xVO5Y2kkYkIG52rjJ65rqP+GbIf8AoNT/APgMP/iqP+GbIf8AoNT/APgMP/iqlRpLoauWKas3+XXc8uwfQ0YPoa9R/wCGbIf+g1P/AOAw/wDiqP8AhmyH/oNT/wDgMP8A4qt/bROX6rU7Hl2D6GjB9DXqP/DNkP8A0Gp//AYf/FUf8M2Q/wDQauP/AAGH/wAVR7aIfVanY8uwfQ0YPoa9RH7NkJOP7am/8Bh/8VUifsw703Lq10wPQi0GP/QqPbRD6rUPKsH0NZuvf62L/d/rXtP/AAy6T01W6z/16D/4qvPPjd8N1+G9xpqi8kujdrITmIJs2kDHU+tJ1YyVkaUaMoTUpH1P4A5+JOm/9ff9Wr3Ek8c14d4A/wCSj6d/1+f1avcCcAV+c8U/x4f4f1P1ngn/AHap/i/RC5OO9MvLqLTbJrm6ngtLZDhpriVYolPoWYgfrXzn/wAFL/8Agpl4K/4JlfBu11/xFa3HiDxN4gkktvDnhu0lEU+qyoAXkdyCIrePK75CCcsFUEmv54f28/2/fiD/AMFEPjLd+LPG9/Ja2BVIdM8NWV3K2kaLEqgbYo2OGdiCzSOCzEnoMCvEw+DnV1eiPralZR0R/VPo+pWviONn029sdTRfvNZXKXIX6lCcVNk+9fx+/Dv4heI/g/4jg1fwf4i13wnqts2+K80fUJbKVGHQ5jYA/Q5HtX7af8ENf+C4WvftVeOrb4L/ABlura98c3Nu8nhrxMkawHxB5S7ntLlFwouQgZ1kUDzArAjcMm6+XzhHmi7omGIT0Z+pu4kdf1rzn4/5zpPXrL/7LXo/BXjmvOf2gP8AmE/9tf5LXVw/rj4fP8jx+KF/wm1H6fmjwD4k+EvG2v8AiCObw54mt9G09YFRoHUktICct909QR+Vc/8A8K2+Kn/Q+WX/AH7b/wCIr1iqus61aeHdLnvr+4jtLO2XdLNJ92MZAyfxIr9MUmfj7prqzzH/AIVt8VP+h8sv+/bf/EUf8K2+Kn/Q+WX/AH7b/wCIrrT8dfBmf+Rl0v8A76b/AOJo/wCF6+DD/wAzNpf/AH03+FVeXYjlh3/E5L/hW3xU/wCh8sv+/bf/ABFH/Ctvip/0Pll/37b/AOIrrf8Ahevgz/oZtL/76b/Cj/hevgz/AKGbS/8Avpv8KLvt+AcsO/4nJf8ACtvip/0Pll/37b/4ij/hW3xU/wCh8sv+/bf/ABFdb/wvXwZ/0M2l/wDfTf4VY0j4v+FvEGqwWNjr2n3d5dNsihjZt8hxnA49jReXYOWHf8Tiv+FbfFT/AKHyy/79t/8AEUf8K2+Kn/Q+WX/ftv8A4ivRPFHjfSPBMUEmr6hbadHcsViaYkCQgZIGAemRWR/wvXwZ/wBDNpf/AH03+FK8uw3CHf8AE5L/AIVt8VP+h8sv+/bf/EUf8K2+Kn/Q+Wf/AH7b/wCIrrf+F6+DP+hm0v8A76b/AArR8M/EbQfGl3Lb6Rq1pqE0CebIkJYlFzjJyB34p3fYOSHR/iUPhf4c8TeHra9HibW4tblmdTbtGpHkqAcjoOprwX9pD9m7SfiB8aNY1e5sv2kJZ7sQ7n8KwhtIbbGq/uTuHp83H3s19R/y718sftJ6B4WvfjTrEup/FX4e+Gr5hD5mnand6rHdW/7tcb1gu44+Rgjag4Izk81hU1Wp1UFZ2TOJl/Y80ExsDp/7YWCpGFgXJ+nz17D8d9LTRfBngWyiXVFjs9L8hV1EYvVCrGAJ/wDprx83vmvGJ/CvgcQvn44/Cb7p5N/rnT/wPr2b48RRW/gvwGlvdW1/bppe2K5tS5huUCx4kQuzOVYcjcxODySaVK13Yuupe6mfTPgD/ko+nf8AX5/Vq9xI4/CvDvAH/JR9O/6/P6tXuPpXxHFX8eH+E/QuCf8Adan+L9Efzy/8HNXjTUtf/wCCod1puoSyLpfhfwjpUGmI7YRIpkeeVx6bpGOfXaPSvAfA3/BK/wCPvxH+E+m+MtJ+HmqTaZrskcekWkhEeoaqH6TJCf8AVwAfMZZii4xjORX7C/8ABVr/AIJo2v7SP/BQv9nb4nXGnf2h4XS4bQvGUGzcjparLeWBlH/PN3Dwtnj7o719TtKXJPQNxgcADsMdMDpivz7iLjCWWeyoYeKbau77W/pH6bkfDix6nUqSsk7Kx/Nj4R/YH+LnxD+LWoeC/Dfg6+8Q6npV0bK8v7IE6NbSjAcNesBEyoSVZlJ5U7d1ezfGv9ibxH/wS4/au/Z31q28Rprd/qusadfG8t4TElrqUN7Clxbx92iKSrtZsFgzZFft1rNw/wBvni3t5SOdqA/Kv0HSvmX9sT9nJv2of2z/ANkjw6sJmtdN8aXviDU2K5WKwsbeO5kLezOkSc93Aryco45xePzOlh3FRg7ppa30bvf5f8OelmXClDBYCpWUnKatZ/Psfp1qaCPULlQMBZWAHpya8z/aA/5hP/bX+S16RPKZ5pJD1kYsfqea83/aA/5hP/bX+S1+kcPf7/D5/kz8z4n/AORbU+X5o84qtrWi2niPSp7G/t47uzuV2ywv91xkHB/ECrNZnjPUtR0jwte3OkWS6lqcKBre1Y4E7bhx1HbJ69q/Sj8iexi/8KE8Ftz/AMIxpv8A3y3+NH/Cg/BX/Qsab/3y3+Ncifih8UM/8k/t/wDv43/xdDfFD4ohDj4f2xIHA8xuf/H6u0u5i5QvqvwOu/4UJ4K/6FnTPyb/ABoHwE8FE/8AIsab+Tf411Vk7TQQGYeVI6KZFH8BIBYfgSa8v1b4k/Eu21W6itvAlvPaxTOkMvmNmVAxCt9/uMGhXfUpqCV7fgdOPgF4KP8AzLGmfk3+NWdG+DXhXw7q0F9YaDYWl5atvimjDboz0yOfeuH/AOFofFH/AKEC3/7+N/8AF0f8LQ+KP/QgW/8A38b/AOLotLv+JPNT7fgej+KfAmj+OIrePWNOt9RS1YvCswJEbEYJGCOorHPwC8FH/mWNM/75b/GuQ/4Wh8Uf+hAt/wDv43/xdH/C0Pij/wBCBb/9/G/+LpKL7/iNzg91+B1//CgvBX/QsaZ+Tf41peGPhtoHgi9luNI0m006eePypHhBBdM5wcnpnmvPv+FofFH/AKEC3/7+N/8AF103ww8X+MPEurXUPiTwzFoVpFAHhmRiTLJuxt5Y/wAPNOzCLhfRHa18X/tbfs7/AA08eftB69qviLx14A0XWLpYPPs9S1W9guodsKqu9IyEGQARjqDzX2h3rwb41fBv4S+LPiZqV/4o+EPizxVrs4jFzqln4evLuC5wgC7ZI3CttXAOBxjFYVFdWOujPllfU+X5v2SPgwYXB+J/wqAKkZOu6jxx/vV9MfGTTbTSPh58PbOxntryxtNHWG2nt3Z4Zo1SMK6M3zFSACCeSOtc4/7PHwGMbBvgB48ZMHI/4RLUST/5ErsP2hLKy0vw34MttOsptO06309o7S0ljaKS0iAQJGyMdysq4BB5BFKlGzZVad7Xv+B9IeAP+Sj6d/1+f1avcT2rw7wAP+Lj6b/1+f1avcSMY+lfEcVfx4f4f1P0Lgn/AHWpb+b9EUfEulHW/D15arnzJY/kHYsOR+oryAZyQQQwOCD1B717Z+deC+OfH9lpnxU1+wu2WCOG5AilA+XlVJVsdDnnPvX4vxzhI8tPFLe/K/zX6n7Twdinzzw723/RnPawP+Jvc/75r0b9njwJbm4l8TT20ZvliewsZ2X54oWZWmCnsGZEB9dleMeNPiRplhJeyW86Xk2WCRoDgnHUk9BX1H8OJEn+HegSx+Xtl06CTKABSSgJI/EmvH4KwkKuOdZv4Ff79D1OLcU6eEVOP23+WptHpXnP7QH/ADCf+2v8lr0btXnP7QB/5BP/AG1/ktfuXD3+/wAPn+R+K8T/APItqfL80ecUDk0VmeNPC0Xjfwte6TPPPbQ3yCN5YSBIgDA8Z47V+lo/I35GpjH/AOsUAZ//AFj/ABryQfsfaIB/yHfEP/fxP8KP+GPdE/6DviL/AL+J/hTtHuZ3n2/E9b2/5yP8aNv+cj/GvJP+GPdE/wCg74i/7+J/hR/wx7on/Qd8Rf8AfxP8KLLv+AXqdvxPW9v+cj/Gjb/nI/xryP8A4Y90T/oO+Iv+/if4Uf8ADHui/wDQd8Q/9/E/wotHv+Ac0+34nrm3/OR/jRt/zkf415H/AMMe6J/0HvEP/fxP8KX/AIY90T/oPeIv+/if4UWj3/AOap2/E9b2/wCcj/GkPy9RXkv/AAx7on/Qd8Rf9/E/wrpfhf8AA6w+FOr3d5Z6lql895AIGS6ZSqgMGyMDrkUWQJzvqjta+Zv2htP8HTfGHVm1Txz8KtF1AiLzbPWb/VIr2L92uN6w3SRjI5G1BwRnJ5r6Z718M/tj+BtF1r9pPxHdXnws+JPiS4kFvv1HStFtrm0uMQqBsd0LHHQ5PBBrGo7I66CTlY2JdK+H3lNn4nfAsDByTqmt4HHU/wCm16r8d0gTwf4GW2uLO6t10zEU9oztbzpiPDxlyzFCOQWYnBGSTXyFcfDLw2beTPwQ+MeCpHHhyzyeOn3K+sfi7bJbfDT4cxRWl1YRRaKiJa3MYjntVCRARyKOFdehA4BBpUW2yq0OWx9Q+Azt+I+m/wDX4f5tXusFnNdLmOKRwvUqpIH418cftTfH2/8A2Vv2e/HnxK0uwtdT1PwVpdxqVnbXRIglnDbI/MxyUDOGIHJ244zmv5//ANp3/gpT+0D+0ulxd+L/AIweOryKWTe1jY6k+nWEan+BYICiBR2HNeLmeRVsfVjUi0lFW1PquGc2pYWhKnUTbcv0R/SF+3L/AMFPfgv/AME8/Bc+p/EHxfYtqwX/AETw3pU0d5rWoNkDCQK2UAzkvIVUAdc8V09xqfwf/aW/Z7tvi9p/iDTYPBd/pDa5/wAJVbSiKKK1RC0j3APGY9rB1YblZSvWv5ApZvOupLiR2luJm3SSyOWkkPqWPJP1Nem+Gv2y/iT4N/ZW8S/BTTPFl/a/DXxbqUWq6noyv+7lmj5wrdUjkIRpEGFdo0J6Vx1+DcNUo+yqpTu9br8ux9ZQ4iq06vPC8fQ/pZ/4JaXvwU/4KD/DK++IPh/U9S8SRWGqTWVxpF/ELR7Iq58mSWJSWZZowsiEnBDEYypA6ey/4K1fs7av+1b4h+D1h4x0vQ9X8MGOxiuropbaNqFwoIltba4J2eZEQFZW2gkkKTg1/Od+yX+1n8Q/2TdF1e5+Hvii+8NzeMNAfQ9Ue3PM1u/dc/dlTnZIPmTc2OtcMYUaIoyhlPXd82fUnPXnua7sv8Ocvw0ZU6C5Yu1mt/m+p87mXiJi6zTqe9JNp32t5dj+va1ha+slubfbc27jcssLCWNh6hlyCPfNeb/H/ppP1l/ktfy7+C/2lfiL8Ao4pfBXxA8Z+E5VcCP+y9Znt40xzwgbZ/47X64f8EXf+Ci3xK/bm+GHivQ/ifqkXiXV/h/PbNZ660SRXl5BchwYrgIArsjRZEmASGwc4BqKHCtXAYqNZTUorfozLMOJaWPwE4KLjLT80faNZnjLxVb+B/C17q93HPLbWCCR1hALsNwHAP1rToIyOQD9RmvoEfDNXR5OP2yfDI6adr+P+uKf/FUn/DZPhn/oHa9/35T/AOKr1jyk/wCecX/fAo8pP+ecX/fAqrx7GfLPv+B5P/w2T4Z/6B2vf9+U/wDiqP8Ahsnwz/0Dte/78p/8VXrHlJ/zzi/74FHlJ/zzi/74FF12/EOWff8AA8ssf2vvDeoX1vbrp+vB7mVYUJhTaCxAGfm6c16sYisxQ4yDtpgjQf8ALOMf8AFLS0Kimtzyq6/a/wDDdldzQPp2vF4JGjYrCm0lSQcfN0qM/tk+Gv8AoHa9/wB+U/8Aiq9X8pP+ecX/AHwP8KXyk/55xf8AfAp3j2Fyy7/geT/8NleGv+gfr3/flP8A4qul+GPx10j4s6tdWWm2mpQTWkAnc3MYVWBYLgYJ55zXZ+Un/POL/vgUBFXoiL9FAouuwKMr6sXGePWvln9pD9oPRfA/xp1nSrvxJ8RNPubYQ74NL8e2Gl2qbolI2W8vzpwec9TkjivqYjNfOnx58DaBrHxY1W5v9L/ZtubmURb5PFd1MmrtiNQPOCnA44XH8OKyqXtodNG19UeVS/tXeG0hYt4z+LmAD/zVPSwfzr2T47agmseDPAl3FLdTRXWl+cklxcLcTSKyxkM8q/LIxzy44J5FcBJ8MvCpiYf2J+x1gqRzfXGPx56V6J8f4IrTwv4KhiTS0ii00rGumsfsSqBGAICeTFj7uf4cVNK92Oq43Vkey+P/AAPo3xN8Lav4e8RaZa6zoWso9tf2FypaG7iL5KMB1GQD+FeNSf8ABLr9nCeIo/wU8Buh6g2smD/4/XvuoQtbX9xG4w8czow9CGINcL8Uvipf/D3U7KC08NahryXULSNJblsQkNjacKeT1raF2tDJVHTvZ2PNR/wSm/Zn7/A3wB/4CSf/ABdL/wAOpv2Zv+iG+AP/AAEk/wDi66MftK60P+aea5+b/wDxul/4aW1r/onmufm//wAbp+yZX1+r/O/vZkW//BM79ni1hWOL4NeB40ThVFq+AP8Avunn/gmr+z2evwc8Dn/t1f8A+LrU/wCGlta/6J5rn5v/APG6P+Glta/6J5rn5v8A/G6tc60uYuvd3ZkT/wDBMv8AZ4ulUSfBrwM4U8ZtpOP/AB+u1+Cn7L/w5/Zt/tP/AIV/4K0Lwgda8sX/APZsTR/a/L3eXvyTnbubH1NYP/DS2tf9E81z83/+N0f8NLa1/wBE81z83/8AjdJxm92P6xpy3dj1mivJv+Glta/6J5rn5v8A/G6P+Glta/6J5rn5v/8AG6Xs2T7WJ6zRXk3/AA0trX/RPNc/N/8A43R/w0trX/RPNc/N/wD43R7Nh7WJ6zRXk3/DS2tf9E81z83/APjdH/DS2tf9E81z83/+N0ezYe1ies0V5N/w0trX/RPNc/N//jdH/DS2tf8ARPNc/N//AI3R7Nh7WJ6zRXk3/DS2tf8ARPNc/N//AI3R/wANLa1/0TzXPzf/AON0ezYe1ies0V5N/wANLa1/0TzXPzf/AON0f8NLa1/0TzW/zf8A+N0ezYe1ies4P/6+K+G/2xv2S7X4oftIeItcl8OeLNQe9FuPPs4J2gfbCq/KVtnHGMHDHn0r7C+GPjq6+IegT3t3o13ocsU5gFvcZ3OoUHeMgcc46dq+Uv2tPj3ofgn9oPXtMvPgbonjG5tlg36xcaw1vJd7oVIBTttzt/CsK0VbU6cNJ814s8an/YKsXhdf+EP8dZKkcWt16f8AXnX1j8X9GGgfDX4daesU0IsNFS3EcoIkjCJEu1sgHcMc5A+gr5ruP2pPDPkSZ/Zm8NsNp4/4SF+ePrX0z8W7j/hI/AXgCe00trFZtFjuBYQEyiwV1QrFu7hcFQe+2oo8qu0a15Tbjz/1ofaX7Tvwo/4RKa88VWabtMfM2oICM2zdTIASNynuBznoDmvC7f4seHJIg8erLtkAYHyJhkHp/BRRXPlVSU6L5nsejxRQhh8UnSVuZXfqP/4WtoH/AEFx/wB+Zv8A4ij/AIWtoH/QXH/fmb/4iiivSsfNe3kH/C1tA/6C4/78zf8AxFH/AAtbQP8AoLj/AL8zf/EUUUWD28g/4WtoH/QXH/fmb/4ij/ha2gf9Bcf9+Zv/AIiiiiwe3kH/AAtbQP8AoLj/AL8zf/EUf8LW0D/oLj/vzN/8RRRRYPbyD/ha2gf9Bcf9+Zv/AIij/ha2gf8AQXH/AH5m/wDiKKKLB7eQf8LW0D/oLj/vzN/8RR/wtbQP+guP+/M3/wARRRRYPbyD/ha2gf8AQXH/AH5m/wDiKP8Aha2gf9Bcf9+Zv/iKKKLB7eQf8LW0D/oLj/vzN/8AEUf8LW0D/oLj/vzN/wDEUUUWD28g/wCFraB/0Fx/35m/+Io/4WvoH/QXH/fmb/4iiiiwe3kI3xU8Pv11VT25gmP/ALJVG98WeCtSuWmuRo11M/3pJ9K8129Ms0RJ/Oiik4p7jVeRQv8Axl4Dsbm1totM0e/vtQlEFrawaNEslzIeiBnjVFz6swFfUP7Mv7ML+GtH1DWPGtjp8uta4Ylj06LbJb6NaxBvKt0IGGb53Z2UAEtgcAUUV5GcVJU1GEOp9lwjh6dapOrUV3Hbtqf/2Q=="

async def GenerateCustomerProfile(data: CustomerRegistrationSchema) -> str:
    try:
        #Load Photos
        try:
            live_photo = await _GetPhoto(data.tracking_id, "live_photo.bin")
        except Exception as e:
            error_msg = f"{str(e)}\n{traceback.format_exc()}"
            await AddLogOrError(SystemLogErrorSchema(
                Msg=error_msg,
                Type="ERROR",
                ModuleName="ReportServices/_GenerateCustomerProfile",
                CreatedBy=""
            ))
            live_photo = DEFAULT_USER_PHOTO
            
        try:
            id_front_photo = await _GetPhoto(data.tracking_id, "id_front_photo.bin")
        except Exception as e:
            error_msg = f"{str(e)}\n{traceback.format_exc()}"
            await AddLogOrError(SystemLogErrorSchema(
                Msg=error_msg,
                Type="ERROR",
                ModuleName="ReportServices/_GenerateCustomerProfile",
                CreatedBy=""
            ))
            id_front_photo = DEFAULT_ID_PHOTO
            
            
        # Load HTML template
        env = Environment(
            loader=FileSystemLoader(report_template_path),
            autoescape=select_autoescape(["html", "xml"])
        )
        template = env.get_template("customer_info_template.html")

        # Format the birth date if it's not already formatted
        try:
            if data.birth_date and isinstance(data.birth_date, str):
                data.birth_date = datetime.strptime(data.birth_date, "%Y-%m-%d").strftime("%d-%b-%Y")
        except:
            data.birth_date = data.birth_date 

        html_content = template.render(
            name=data.name,
            first_name=data.first_name,
            last_name=data.last_name,
            birth_date=data.birth_date.strftime("%d-%b-%Y"),
            tax_id=data.tax_id,
            tax_id_type=data.tax_id_type,
            is_tax_id_verified=data.is_tax_id_verified,
            address_type=data.address_type,
            line_1=data.line_1,
            line_2=data.line_2,
            line_3=data.line_3,
            line_4=data.line_4,
            city=data.city,
            state_code=data.state_code,
            zipcode=data.zipcode,
            country_code=data.country_code,
            customer_id=data.customer_id,
            account_no=data.account_number,
            user_potrate_photo=f"data:image/jpeg;base64,{live_photo}",
            user_nid_front_photo=f"data:image/jpeg;base64,{id_front_photo}",
            generated_on=datetime.now().strftime("%d-%b-%Y %H:%M")
        )

        # Convert HTML to PDF
        html = HTML(string=html_content, base_url=str(report_template_path.resolve()))
        buffer = io.BytesIO()
        html.write_pdf(target=buffer)
        buffer.seek(0)

        # Convert PDF to Base64
        return base64.b64encode(buffer.read()).decode("utf-8")

    except Exception as ex:
        error_msg = f"{str(ex)}\n{traceback.format_exc()}"
        await AddLogOrError(SystemLogErrorSchema(
            Msg=error_msg,
            Type="ERROR",
            ModuleName="ReportServices/_GenerateCustomerProfile",
            CreatedBy=""
        ))
        raise Exception(ex)
    
    
async def _GetPhoto(tracking_no:str, photo_name:str):
    encrypted_tracking_no = await GetSha1Hash(tracking_no)
    filepath = os.path.join('/app/CustomerPhotos', encrypted_tracking_no, photo_name)
    
    if not os.path.exists(filepath):
        raise ValueError("Picture file not found on server.")

    # Read encrypted bytes from file
    with open(filepath, "rb") as f:
        encrypted_image = f.read()

    # Decrypt image bytes
    decrypted_image = await DecryptImage(encrypted_image)

    # Encode to base64 for sending over API
    base64_image = base64.b64encode(decrypted_image).decode('utf-8')
    return base64_image